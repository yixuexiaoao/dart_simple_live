# =================================================================================
# GitHub Actions Workflow: å‘å¸ƒ TV App Release ç‰ˆæœ¬
# ä¼˜åŒ–ç‰ˆæœ¬ by èµ„æ·±Androidå¼€å‘ä¸ä»£ç å®¡æŸ¥ä¸“å®¶
#
# ä¼˜åŒ–ç‚¹:
# 1. (é‡è¦) ç§»é™¤äº† 'checkout' ä¸­çš„ 'ref: master'ï¼Œç¡®ä¿æ„å»ºçš„æ˜¯è§¦å‘æ ‡ç­¾æ‰€åœ¨çš„ä»£ç ã€‚
# 2. ä½¿ç”¨ 'working-directory' æ›¿ä»£ 'cd' å‘½ä»¤ï¼Œä½¿è„šæœ¬æ›´å¥å£®ã€æ›´æ¸…æ™°ã€‚
# 3. åœ¨ä¸Šä¼ äº§ç‰©æ—¶ä½¿ç”¨é€šé…ç¬¦è·¯å¾„ï¼Œä»¥é€‚åº”æœªæ¥å¯èƒ½çš„å˜åŒ–ã€‚
# =================================================================================

name: Publish TV App Release

# æ¨é€ 'tv_*' æ ¼å¼çš„Tagæ—¶è§¦å‘
on:
  push:
    tags:
      - "tv_*"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release-tv: # Jobåç§°æ›´å…·æè¿°æ€§
    name: Build and Release TV App
    runs-on: macos-latest
    permissions:
      contents: write # 'softprops/action-gh-release' éœ€è¦æ­¤æƒé™æ¥åˆ›å»ºRelease

    steps:
      # æ­¥éª¤1: ç­¾å‡ºä»£ç 
      # <--- ä¼˜åŒ–ç‚¹1: ç§»é™¤ ref: masterï¼Œè®© action è‡ªåŠ¨æ£€å‡ºè§¦å‘äº‹ä»¶çš„ tag
      - name: Checkout repository at tag
        uses: actions/checkout@v4
        
      # æ­¥éª¤2: APKç­¾åè®¾ç½® (ä¿æŒä¸å˜ï¼Œå·²æ˜¯æœ€ä½³å®è·µ)
      - name: Download Android keystore
        id: android_tv_keystore
        uses: timheuer/base64-to-file@v1.2
        with:
          fileName: keystore.jks
          encodedString: ${{ secrets.TV_KEYSTORE_BASE64 }}
      - name: Create key.properties
        run: |
          echo "storeFile=${{ steps.android_tv_keystore.outputs.filePath }}" > simple_live_tv_app/android/key.properties
          echo "storePassword=${{ secrets.TV_STORE_PASSWORD }}" >> simple_live_tv_app/android/key.properties
          echo "keyPassword=${{ secrets.TV_KEY_PASSWORD }}" >> simple_live_tv_app/android/key.properties
          echo "keyAlias=${{ secrets.TV_KEY_ALIAS }}" >> simple_live_tv_app/android/key.properties

      # æ­¥éª¤3: è®¾ç½®JAVAç¯å¢ƒ (ä¿æŒä¸å˜ï¼Œå·²æ˜¯æ­£ç¡®é…ç½®)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: "17"
          cache: "gradle"
    
      # æ­¥éª¤4: è®¾ç½®Flutterç¯å¢ƒ (ä¿æŒä¸å˜)
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.x'
          cache: true

      # æ­¥éª¤5: è·å–Flutterä¾èµ–åŒ…
      # <--- ä¼˜åŒ–ç‚¹2: ä½¿ç”¨ working-directory æ›¿ä»£ cd
      - name: Get Flutter dependencies
        working-directory: ./simple_live_tv_app
        run: flutter pub get
        
      # æ­¥éª¤6: æ‰“åŒ…APK
      # <--- ä¼˜åŒ–ç‚¹2: ä½¿ç”¨ working-directory æ›¿ä»£ cd
      - name: Build release APK
        working-directory: ./simple_live_tv_app
        run: flutter build apk --release --split-per-abi
    
      # æ­¥éª¤7: ä¸Šä¼ APKè‡³Artifacts
      # <--- ä¼˜åŒ–ç‚¹3: ä½¿ç”¨é€šé…ç¬¦ä½¿è·¯å¾„æ›´å¥å£®
      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android_tv-apks
          path: simple_live_tv_app/build/app/outputs/flutter-apk/app-*-release.apk
    
      # æ­¥éª¤8: è¯»å–ç‰ˆæœ¬ä¿¡æ¯ (ä¿æŒä¸å˜)
      - name: Read version information
        id: version
        uses: juliangruber/read-file-action@v1
        with:
          path: assets/tv_app_version.json # ç¡®ä¿è¿™ä¸ªè·¯å¾„ç›¸å¯¹äºä»“åº“æ ¹ç›®å½•æ˜¯æ­£ç¡®çš„
      - name: Echo version details
        run: |
          echo "Version: ${{ fromJson(steps.version.outputs.content).version }}"
          echo "Description: ${{ fromJson(steps.version.outputs.content).version_desc }}"
    
      # æ­¥éª¤9: åˆ›å»ºå¹¶ä¸Šä¼ è‡³GitHub Release
      # <--- ä¼˜åŒ–ç‚¹3: ä½¿ç”¨é€šé…ç¬¦ä½¿è·¯å¾„æ›´å¥å£®
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2 # å»ºè®®ä½¿ç”¨æœ€æ–°çš„ v2 ç‰ˆæœ¬
        with:
          name: "Version ${{ fromJson(steps.version.outputs.content).version }}"
          body: |
            # Android TV Release
            ${{ fromJson(steps.version.outputs.content).version_desc }}
          prerelease: ${{ fromJson(steps.version.outputs.content).prerelease }}
          files: simple_live_tv_app/build/app/outputs/flutter-apk/app-*-release.apk
        
      # æ­¥éª¤10: å®Œæˆ
      - name: Job Summary
        run: echo "ğŸ This job's status is ${{ job.status }}."

